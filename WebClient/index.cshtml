@{
    Layout = "~/_Layout.cshtml";
}

@section CustomCss{
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .sidebar-nav {
            padding: 9px 0;
        }
    </style>
}

@section FooterJs{
    <script type="text/javascript" 
        src="http://maps.googleapis.com/maps/api/js?key=@System.Configuration.ConfigurationManager.AppSettings["googleApiKey"]&sensor=false">
    </script>

    <script type="text/javascript">
        var apiKey = "@System.Configuration.ConfigurationManager.AppSettings["googleApiKey"]";

        var server = "@System.Configuration.ConfigurationManager.AppSettings["server"]";

        function sortTrainId(trainId) {
            if (!trainId || trainId.length == 0)
                return;

            var rows = $("#table-trains tbody tr." + trainId).not(".info, .warning");
            if (rows.length <= 1)
                return;

            var header = $("#table-trains tbody tr." + trainId + ".info").get(0);

            $(rows).each(function (el) {
                $(el).detach();
            });

            var ordered = rows.get().sort(function (a, b) {
                return $(a).data("timestamp") - $(b).data("timestamp");
            });

            $(header).after(ordered);
        }

        function padTime(time) {
            if (time < 10)
                return "0" + time;
            return time;
        }

        function setStatus(status) {
            $("#status").html(status);
        }

        function addMessage(message, parent) {
            if (parent) {
                $("#" + parent).after(message);
            } else {
                $("#data").append(message);
            }
        }

        var currentFilter = '';

        function clearTable() {
            $("#table-trains tbody tr").detach();
        }

        var _locations;

        var currentLocation = new LocationViewModel();

        function preLoadStationsCallback(results) {
            var locations = [];
            for (i in results) {
                locations.push(results[i].StaionName + ' (' + results[i].CRS + ')');
            }
            $("#filter-location").typeahead({
                source: results,
                updater: function (item) {
                    filter(item.substring(0, (item.indexOf('(') - 1)));
                    return item;
                }
            });
        }

        $(function () {
            ko.applyBindings(currentLocation, $("#locationDetails").get(0));

            preLoadStations(preLoadStationsCallback);

            preLoadMap();

            $('#filter-location').on('change', function (evt) {
                if ($(evt.target).val() == '') {
                    filter(null);
                }
            });
        });

        function wsOpenCommand() {
            ws.send("subscribe");
        }

        function connectWs() {
            connect();

            ws.onmessage = function (msg) {
                var data = jQuery.parseJSON(msg.data);
                console.debug(data);
                setStatus("Received " + data.length + " messages at " + new Date(Date.now()).toLocaleString());

                $("#status").removeClass("btn-warning");
                $("#status").removeClass("btn-success");
                $("#status").addClass("btn-info");

                for (var i = 0; i < data.length; i++) {
                    var message = data[i]; //.body;

                    var existing = $("#" + message.train_id).length == 1;
                    var cls = "";
                    if (existing) {
                        $("." + message.train_id).addClass(message.loc_stanox);
                        cls = $("#" + message.train_id).attr('class');
                        cls = cls.replace(" info", "");
                        parent = message.train_id;
                    } else {
                        parent = null;
                        cls = message.loc_stanox + " " + message.train_id;
                    }

                    var style = "";
                    if (currentFilter &&
                        currentFilter.length > 0 &&
                        cls.indexOf(currentFilter) == -1) {
                        style = "display:none;";
                    }

                    var date = new Date(new Number(message.actual_timestamp));
                    var html = "";

                    if (!existing) {
                        html += "<tr class=\"" + cls + " info\" style=\"" + style + "\" id=\"" + message.train_id + "\">";
                        html += "<td><a href=\"train#gettrain:" + message.train_id + "\" title=\"View this train\">" + message.train_id + "</a></td>";
                        html += "<td>" + message.train_service_code + "</td>";
                        html += "<td colspan=\"5\"><a href=\"#\" data-toggle=\"modal\" data-target=\"#mapModal\" onclick=\"showMap('" + message.train_id + "');\">View Map</button></td>";
                        html += "</tr>";
                    }

                    html += "<tr class=\"" + cls + "\" style=\"" + style + "\" data-timestamp=\"" + message.actual_timestamp + "\">";
                    html += "<td colspan=\"2\">&nbsp;&nbsp;</td>";
                    html += "<td>" + message.event_type + "</td>";
                    html += "<td>" + padTime(date.getUTCHours()) + ":" + padTime(date.getUTCMinutes()) + ":" + padTime(date.getUTCSeconds()) + "</td>";
                    html += "<td>" + message.direction_ind + "</td>";
                    html += "<td>" + message.platform + "</td>";
                    html += "<td><a href=\"train#stanox:" + message.loc_stanox + "\" class=\"stanox-" + message.loc_stanox + "\" title=\"View this location\">" + message.loc_stanox + "</a></td>";

                    html += "</tr>";

                    if (message.train_terminated && message.train_terminated == "true") {
                        html += "<tr class=\"" + cls + " " + message.train_id + " warning\"  style=\"" + style + "\"><td colspan=\"7\">Terminated</td></tr>";
                    }

                    addMessage(html, parent);

                    sortTrainId(message.train_id);

                    fetchStanox(message.loc_stanox);
                }
            };
        }

    </script>

}

@section TopMenu{
    <li class="active"><a href="#">Live Feed</a></li>
    <li><a href="~/train">Train</a></li>
    <li><a href="~/search">Search</a></li>
}

<div class="row-fluid">
    <div class="span12">
        <div class="btn-group">
            <div class="input-prepend">
                <a class="btn btn-connect" onclick="connectWs();" title="Connect to server"><i class="icon-play"></i></a>
                <a class="btn btn-disconnect" onclick="disconnect();" disabled="disabled" title="Disconnect from server"><i class="icon-stop"></i></a>
                <a class="btn" href="#" title="Clear table" onclick="clearTable();"><i class="icon-remove"></i></a>
                <a class="btn" href="#" id="status">Connection Status</a>
            </div>
        </div>
        <div class="navbar-inner">
            <form class="navbar-search pull-right" onsubmit="return false;">
                <div class="input-prepend" style="margin-right: 20px">
                    <span class="add-on"><i class="icon-filter"></i></span>
                    <input type="text" id="filter-location" class="span12" placeholder="Filter Table Location" title="Clear and press ENTER to reset" />
                    <br />
                </div>
            </form>
        </div>
        <div style="height: 800px; overflow: auto;">
            <table class="table table-hover table-bordered" id="table-trains">
                <thead>
                    <tr>
                        <th>Train ID</th>
                        <th>Service Code</th>
                        <th>Action</th>
                        <th>Time</th>
                        <th>Direction</th>
                        <th>Platform</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="data">
                </tbody>
            </table>
        </div>
    </div>
    <!--/span9-->
</div>
<!--/row-fluid-->
@section PostContainer{
    <div id="mapModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="mapModalLabel">Train Map</h3>
        </div>
        <div class="modal-body" style="width: 400px; height: 400px;">
            <div id="map_canvas" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
}